#!/bin/bash
################################################################################
# SPRINT 62 - Script 5: Atualiza√ß√£o das Configura√ß√µes da Aplica√ß√£o
# 
# Este script atualiza os arquivos de configura√ß√£o com as novas credenciais
# 
# EXECUTAR NO VPS como root via SSH
#
# Autor: GenSpark AI
# Data: 2025-11-16
################################################################################

set -e  # Exit on error

echo "=========================================================================="
echo "  SPRINT 62 - Atualiza√ß√£o de Configura√ß√µes"
echo "=========================================================================="
echo ""

# Verificar se est√° rodando como root
if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå ERRO: Este script deve ser executado como root"
    echo "   Use: sudo bash 5_update_config.sh"
    exit 1
fi

# Configura√ß√µes
SITE_NAME="prestadores"
SITE_ROOT="/opt/webserver/sites/$SITE_NAME/public_html"
CONFIG_FILE="$SITE_ROOT/config/database.php"

echo "üìã Configura√ß√£o:"
echo "   Site Root: $SITE_ROOT"
echo "   Config File: $CONFIG_FILE"
echo ""

# Verificar se o diret√≥rio existe
if [ ! -d "$SITE_ROOT" ]; then
    echo "‚ùå ERRO: Diret√≥rio do site n√£o encontrado: $SITE_ROOT"
    exit 1
fi

# Solicitar credenciais do banco de dados
echo "üîê Digite as credenciais do banco de dados do VPS"
echo "   (As mesmas usadas no Script 4)"
echo ""
read -p "   Database Name [$SITE_NAME_db]: " DB_NAME
DB_NAME=${DB_NAME:-"${SITE_NAME}_db"}

read -p "   Database User [${SITE_NAME}_user]: " DB_USER
DB_USER=${DB_USER:-"${SITE_NAME}_user"}

read -s -p "   Database Password: " DB_PASS
echo ""

read -p "   Database Host [localhost]: " DB_HOST
DB_HOST=${DB_HOST:-"localhost"}

echo ""

if [ -z "$DB_PASS" ]; then
    echo "‚ùå ERRO: Senha n√£o pode ser vazia"
    exit 1
fi

# Testar conex√£o
echo "üöÄ Etapa 1: Testando conex√£o com o banco de dados..."
mysql -u "$DB_USER" -p"$DB_PASS" -h "$DB_HOST" "$DB_NAME" -e "SELECT 1;" &> /dev/null

if [ $? -ne 0 ]; then
    echo "‚ùå ERRO: N√£o foi poss√≠vel conectar ao banco de dados"
    echo "   Verifique as credenciais e tente novamente"
    exit 1
fi

echo "‚úÖ Conex√£o estabelecida!"
echo ""

# Fazer backup do config atual
echo "üöÄ Etapa 2: Fazendo backup das configura√ß√µes atuais..."
if [ -f "$CONFIG_FILE" ]; then
    BACKUP_FILE="${CONFIG_FILE}.backup_$(date +%Y%m%d_%H%M%S)"
    cp "$CONFIG_FILE" "$BACKUP_FILE"
    echo "   ‚úÖ Backup salvo: $BACKUP_FILE"
else
    echo "   ‚ö†Ô∏è  Arquivo de configura√ß√£o n√£o encontrado, ser√° criado"
fi
echo ""

# Criar novo arquivo de configura√ß√£o
echo "üöÄ Etapa 3: Criando novo arquivo de configura√ß√£o..."

mkdir -p "$(dirname "$CONFIG_FILE")"

cat > "$CONFIG_FILE" << EOF
<?php
/**
 * Configura√ß√£o do Banco de Dados
 * 
 * Atualizado automaticamente pela migra√ß√£o VPS
 * Data: $(date '+%Y-%m-%d %H:%M:%S')
 */

return [
    'host' => '$DB_HOST',
    'database' => '$DB_NAME',
    'username' => '$DB_USER',
    'password' => '$DB_PASS',
    'charset' => 'utf8mb4',
    'collation' => 'utf8mb4_unicode_ci',
    'prefix' => '',
];
EOF

echo "   ‚úÖ Arquivo criado"
echo ""

# Ajustar permiss√µes
echo "üöÄ Etapa 4: Ajustando permiss√µes..."
chown $SITE_NAME:$SITE_NAME "$CONFIG_FILE"
chmod 640 "$CONFIG_FILE"  # Somente owner pode ler/escrever
echo "   ‚úÖ Permiss√µes: 640 (rw-r-----)"
echo ""

# Atualizar outros arquivos de configura√ß√£o se necess√°rio
echo "üöÄ Etapa 5: Verificando outros arquivos de configura√ß√£o..."

# config/app.php
APP_CONFIG="$SITE_ROOT/config/app.php"
if [ -f "$APP_CONFIG" ]; then
    echo "   üìÑ Encontrado: config/app.php"
    
    # Fazer backup
    cp "$APP_CONFIG" "${APP_CONFIG}.backup_$(date +%Y%m%d_%H%M%S)"
    
    # Atualizar URL base (se necess√°rio)
    # sed -i "s|'base_url' => '.*'|'base_url' => 'https://prestadores.clinfec.com.br'|g" "$APP_CONFIG"
    
    echo "   ‚ÑπÔ∏è  Revise manualmente se necess√°rio"
fi

# config/config.php
GENERAL_CONFIG="$SITE_ROOT/config/config.php"
if [ -f "$GENERAL_CONFIG" ]; then
    echo "   üìÑ Encontrado: config/config.php"
    cp "$GENERAL_CONFIG" "${GENERAL_CONFIG}.backup_$(date +%Y%m%d_%H%M%S)"
    echo "   ‚ÑπÔ∏è  Revise manualmente se necess√°rio"
fi

echo ""

# Criar arquivo .env se n√£o existir
ENV_FILE="$SITE_ROOT/.env"
if [ ! -f "$ENV_FILE" ]; then
    echo "üöÄ Etapa 6: Criando arquivo .env..."
    cat > "$ENV_FILE" << EOF
# Environment Configuration
# Generated by migration script
# Date: $(date '+%Y-%m-%d %H:%M:%S')

APP_ENV=production
APP_DEBUG=false
APP_URL=https://prestadores.clinfec.com.br

DB_HOST=$DB_HOST
DB_DATABASE=$DB_NAME
DB_USERNAME=$DB_USER
DB_PASSWORD=$DB_PASS

# Timezone
APP_TIMEZONE=America/Sao_Paulo
EOF

    chown $SITE_NAME:$SITE_NAME "$ENV_FILE"
    chmod 640 "$ENV_FILE"
    echo "   ‚úÖ Arquivo .env criado"
else
    echo "   ‚ÑπÔ∏è  Arquivo .env j√° existe, n√£o modificado"
fi

echo ""
echo "üöÄ Etapa 7: Criando arquivo de informa√ß√µes da migra√ß√£o..."
INFO_FILE="$SITE_ROOT/MIGRATION_INFO.txt"
cat > "$INFO_FILE" << EOF
========================================================================
  INFORMA√á√ïES DA MIGRA√á√ÉO - VPS
========================================================================

Data da Migra√ß√£o: $(date '+%Y-%m-%d %H:%M:%S')
Script: Sprint 62 - Migra√ß√£o Hostinger ‚Üí VPS

BANCO DE DADOS:
  Host: $DB_HOST
  Database: $DB_NAME
  User: $DB_USER
  (Senha: armazenada em config/database.php)

DIRET√ìRIOS:
  Root: $SITE_ROOT
  Public: $SITE_ROOT/public
  Config: $SITE_ROOT/config
  Logs: $SITE_ROOT/logs

SERVIDOR:
  IP: $(hostname -I | awk '{print $1}')
  Hostname: $(hostname)
  SO: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)
  PHP: $(php -v | head -1)
  NGINX: $(nginx -v 2>&1)

PR√ìXIMOS PASSOS:
  1. Configurar DNS para apontar prestadores.clinfec.com.br para este IP
  2. Gerar certificado SSL (Script 6)
  3. Testar aplica√ß√£o
  4. Validar todas as funcionalidades

========================================================================
EOF

chmod 644 "$INFO_FILE"
echo "   ‚úÖ Arquivo criado: $INFO_FILE"

echo ""
echo "=========================================================================="
echo "  ‚úÖ SCRIPT 5 CONCLU√çDO"
echo "=========================================================================="
echo ""
echo "üìä Resumo:"
echo "   ‚úÖ Configura√ß√£o do banco atualizada"
echo "   ‚úÖ Permiss√µes ajustadas"
echo "   ‚úÖ Arquivo .env criado"
echo "   ‚úÖ Informa√ß√µes da migra√ß√£o documentadas"
echo ""
echo "üì§ Pr√≥ximos passos:"
echo "   1. Configure o DNS (veja instru√ß√µes no Script 6)"
echo "   2. Gere o certificado SSL"
echo "   3. Teste a aplica√ß√£o"
echo ""
echo "üåê Acesso tempor√°rio via IP:"
echo "   http://$(hostname -I | awk '{print $1}')"
echo ""
