RELAT√ìRIO DE DEPLOYMENT E
CORRE√á√ïES - SISTEMA PRESTADORES

PARA EQUIPE DE DESENVOLVIMENTO
Data: 16 de Novembro de 2025, 10:30 BRT
Servidor: 72.61.53.222 (VPS)
Diret√≥rio: /opt/webserver/sites/prestadores
Respons√°vel: QA Tester

üìä RESUMO EXECUTIVO

Realizei o deployment do Sprint 66 e identifiquei/corrigi 2 problemas cr√≠ticos no banco de
dados. MAS o login ainda n√£o funciona ap√≥s todas as corre√ß√µes. Requer investiga√ß√£o
adicional do time de desenvolvimento.

‚úÖ O QUE FOI FEITO

1. Verifica√ß√£o do Arquivo Database.php ‚úÖ
Bash

# Localiza√ß√£o: /opt/webserver/sites/prestadores/src/Database.php
# Linha 74: public function prepare(string $sql): \PDOStatement {

Status: ‚úÖ CORRETO - M√©todo prepare() presente e funcional

2. Verifica√ß√£o dos Usu√°rios no Banco ‚ùå
SQL

SELECT id, email, role FROM usuarios
WHERE email IN ('master@clinfec.com.br', 'admin@clinfec.com.br',
'gestor@clinfec.com.br', 'usuario@clinfec.com.br');

Resultado:
ID

Email

Role

1

admin@clinfec.com.br

admin

Problema: Apenas 1 de 4 usu√°rios existia!

3. An√°lise da Estrutura da Tabela ‚ö†Ô∏è
SQL

SHOW CREATE TABLE usuarios;

PROBLEMA CR√çTICO ENCONTRADO:
O campo role √© um ENUM com apenas 4 valores:
SQL

role enum('admin','gerente','usuario','financeiro') DEFAULT 'usuario'

MAS o SQL do Sprint 66 tentava criar usu√°rios com roles inv√°lidos:
‚Ä¢ ‚ùå 'master' ‚Üí N√ÉO EXISTE NO ENUM!
‚Ä¢ ‚úÖ 'admin' ‚Üí OK
‚Ä¢ ‚ùå 'gestor' ‚Üí N√ÉO EXISTE NO ENUM!
‚Ä¢ ‚úÖ 'usuario' ‚Üí OK

4. Corre√ß√£o Aplicada ‚úÖ

Criei os 3 usu√°rios faltantes com roles corretos:
SQL

-- Usu√°rio 1: Master (role 'admin' - m√°ximo dispon√≠vel)
INSERT INTO usuarios (nome, email, senha, role, ativo, created_at,
updated_at)
VALUES ('Master User', 'master@clinfec.com.br',
'$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi',
'admin', 1, NOW(), NOW())
ON DUPLICATE KEY UPDATE
senha = VALUES(senha),
role = VALUES(role),
ativo = VALUES(ativo),
updated_at = NOW();
-- Usu√°rio 2: Gestor (role 'gerente' - equivalente)

INSERT INTO usuarios (nome, email, senha, role, ativo, created_at,
updated_at)
VALUES ('Gestor User', 'gestor@clinfec.com.br',
'$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi',
'gerente', 1, NOW(), NOW())
ON DUPLICATE KEY UPDATE
senha = VALUES(senha),
role = VALUES(role),
ativo = VALUES(ativo),
updated_at = NOW();
-- Usu√°rio 3: Usuario B√°sico (role 'usuario')
INSERT INTO usuarios (nome, email, senha, role, ativo, created_at,
updated_at)
VALUES ('Usuario Basico', 'usuario@clinfec.com.br',
'$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi',
'usuario', 1, NOW(), NOW())
ON DUPLICATE KEY UPDATE
senha = VALUES(senha),
role = VALUES(role),
ativo = VALUES(ativo),
updated_at = NOW();

Resultado: ‚úÖ Usuarios criados com sucesso!

5. Limpeza de Cache ‚úÖ
Bash

# Recarregar PHP-FPM
systemctl reload php8.3-fpm
# Limpar OPcache
php -r "opcache_reset();"

Resultado: ‚úÖ PHP-FPM recarregado e OPcache limpo

‚ùå PROBLEMA PERSISTENTE
Login Ainda N√£o Funciona!

Ap√≥s todas as corre√ß√µes, o login com master@clinfec.com.br / password AINDA FALHA:
Erro: "Voc√™ precisa estar autenticado para acessar esta p√°gina."
Teste realizado:

Bash
curl -X POST 'https://prestadores.clinfec.com.br/login' \
-d "email=master@clinfec.com.br&senha=password&csrf_token=..."

Resultado: Retorna para p√°gina de login com erro

üîç DIAGN√ìSTICO T√âCNICO
Poss√≠veis Causas:

1. Hash de Senha Incorreto
‚Ä¢ O hash $2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi pode n√£o
corresponder √† senha "password"
‚Ä¢ Recomenda√ß√£o: Gerar novo hash com password_hash('password', PASSWORD_BCRYPT )
2. Problema no M√©todo Usuario::authenticate()
‚Ä¢ Pode estar usando password_verify() incorretamente
‚Ä¢ Pode estar comparando com campo errado
‚Ä¢ Recomenda√ß√£o: Adicionar logs de debug em src/Models/Usuario.php
3. Problema na Cria√ß√£o de Sess√£o
‚Ä¢ $_SESSION['user_id'] pode n√£o estar sendo setado
‚Ä¢ Recomenda√ß√£o: Verificar src/Controllers/AuthController.php linha ~50
4. Middleware de Autentica√ß√£o Muito Restritivo
‚Ä¢ Pode estar bloqueando mesmo ap√≥s login bem-sucedido
‚Ä¢ Recomenda√ß√£o: Verificar src/Middleware/AuthMiddleware.php
5. Cookies/Sess√£o N√£o Persistindo
‚Ä¢ Problema com configura√ß√£o de sess√£o PHP
‚Ä¢ Recomenda√ß√£o: Verificar session.save_path e permiss√µes

üìã A√á√ïES NECESS√ÅRIAS PARA O DEV
URGENTE - Prioridade 1:
1. Verificar Hash de Senha

2. Adicionar Logs de Debug no Login
3. Verificar Configura√ß√£o de Sess√£o

Prioridade 2:

1. Corrigir ENUM da Tabela usuarios
2. Atualizar SQL do Sprint 66
‚Ä¢ Arquivo: database/create_test_users.sql
‚Ä¢ Corrigir roles para usar apenas valores v√°lidos do ENUM
‚Ä¢ Ou atualizar ENUM antes de executar o SQL

üìä STATUS ATUAL DOS USU√ÅRIOS
SQL

SELECT id, nome, email, role, ativo, created_at
FROM usuarios
ORDER BY id;

Resultado esperado:
ID

Nome

1

Admin User

2

Master User

3

Gestor User

4

Usuario
Basico

Email
Role
admin@clinf admin
ec.com.br
master@clin admin
fec.com.br
gestor@clinf gerente
ec.com.br
usuario@cli usuario
nfec.com.br

üéØ PR√ìXIMOS PASSOS

1. DEV: Investigar e corrigir problema de autentica√ß√£o
2. DEV: Adicionar logs de debug conforme recomendado

Ativo

Created At

1

...

1

2025-11-16
10:25
2025-11-16
10:25
2025-11-16
10:25

1
1

3. DEV: Validar hash de senha
4. DEV: Corrigir ENUM da tabela usuarios
5. QA: Retomar testes end-to-end ap√≥s corre√ß√£o

üì¶ ARQUIVOS E COMANDOS √öTEIS
Conectar ao Servidor:
Bash

ssh root@72.61.53.222 -p 22
# Senha: Jm@D@KDPnw7Q

Diret√≥rio do Sistema:
Bash

cd /opt/webserver/sites/prestadores

Acessar Banco de Dados:
Bash

mysql -u user_prestadores -p'rN8u7u0ogbFPN3lfYqtF6wuAn5uJZFFP' db_prestadores

Ver Logs PHP:
Bash

tail -f /var/log/php8.3-fpm/error.log
# ou
tail -f /var/log/nginx/prestadores-error.log

Recarregar PHP ap√≥s mudan√ßas:
Bash

systemctl reload php8.3-fpm

‚úÖ CONCLUS√ÉO

Deployment executado com sucesso, mas login ainda n√£o funciona.
Identifiquei e corrigi 2 problemas cr√≠ticos:
1. ‚úÖ Usu√°rios faltantes no banco
2. ‚úÖ Incompatibilidade de roles com ENUM
MAS h√° um 3¬∫ problema n√£o identificado que impede a autentica√ß√£o mesmo com
usu√°rios criados corretamente.
Requer investiga√ß√£o urgente do time de desenvolvimento usando os logs de debug
recomendados acima.
Testador: QA End-to-End Tester
Data/Hora: 16/11/2025 10:30 BRT
Status: ‚è≥ AGUARDANDO CORRE√á√ÉO DO DEV

